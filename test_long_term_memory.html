<!DOCTYPE html>
<html lang="ko">
<head>
  <meta charset="UTF-8">
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  <title>ì¥ê¸° ê¸°ì–µ ì‹œìŠ¤í…œ í…ŒìŠ¤íŠ¸</title>
  <style>
    body {
      font-family: 'Segoe UI', Tahoma, Geneva, Verdana, sans-serif;
      max-width: 1200px;
      margin: 0 auto;
      padding: 20px;
      background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
      min-height: 100vh;
    }
    .container {
      background: white;
      border-radius: 20px;
      padding: 30px;
      box-shadow: 0 20px 60px rgba(0,0,0,0.3);
    }
    h1 {
      color: #667eea;
      text-align: center;
      margin-bottom: 10px;
    }
    .subtitle {
      text-align: center;
      color: #666;
      margin-bottom: 30px;
      font-size: 14px;
    }
    .section {
      margin-bottom: 30px;
      padding: 20px;
      background: #f8f9fa;
      border-radius: 10px;
      border-left: 4px solid #667eea;
    }
    .section h2 {
      margin-top: 0;
      color: #333;
      font-size: 18px;
    }
    .status {
      display: inline-block;
      padding: 5px 12px;
      border-radius: 15px;
      font-size: 12px;
      font-weight: 600;
      margin-left: 10px;
    }
    .status.ready { background: #d1f4e0; color: #0d7d42; }
    .status.running { background: #fff3cd; color: #856404; }
    .status.success { background: #d1ecf1; color: #0c5460; }
    .status.error { background: #f8d7da; color: #721c24; }

    button {
      background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
      color: white;
      border: none;
      padding: 12px 30px;
      border-radius: 8px;
      cursor: pointer;
      font-size: 14px;
      font-weight: 600;
      transition: transform 0.2s;
      margin-right: 10px;
      margin-bottom: 10px;
    }
    button:hover {
      transform: translateY(-2px);
      box-shadow: 0 5px 15px rgba(102, 126, 234, 0.4);
    }
    button:disabled {
      background: #ccc;
      cursor: not-allowed;
      transform: none;
    }

    .test-scenario {
      background: white;
      padding: 15px;
      margin: 10px 0;
      border-radius: 8px;
      border: 1px solid #e0e0e0;
    }
    .test-scenario h3 {
      margin: 0 0 10px 0;
      color: #667eea;
      font-size: 16px;
    }
    .conversation-history {
      background: #f1f3f4;
      padding: 10px;
      border-radius: 5px;
      font-size: 13px;
      margin: 10px 0;
      max-height: 200px;
      overflow-y: auto;
    }
    .memory-item {
      background: white;
      padding: 8px 12px;
      margin: 5px 0;
      border-radius: 5px;
      border-left: 3px solid #667eea;
      font-size: 13px;
    }
    .result {
      margin-top: 10px;
      padding: 15px;
      border-radius: 8px;
      font-size: 14px;
    }
    .result.success {
      background: #d1f4e0;
      border: 1px solid #0d7d42;
      color: #0d7d42;
    }
    .result.fail {
      background: #f8d7da;
      border: 1px solid #721c24;
      color: #721c24;
    }
    .loading {
      display: inline-block;
      width: 20px;
      height: 20px;
      border: 3px solid #f3f3f3;
      border-top: 3px solid #667eea;
      border-radius: 50%;
      animation: spin 1s linear infinite;
      margin-left: 10px;
    }
    @keyframes spin {
      0% { transform: rotate(0deg); }
      100% { transform: rotate(360deg); }
    }
    .stats {
      display: grid;
      grid-template-columns: repeat(auto-fit, minmax(200px, 1fr));
      gap: 15px;
      margin-top: 20px;
    }
    .stat-card {
      background: white;
      padding: 20px;
      border-radius: 10px;
      text-align: center;
      box-shadow: 0 2px 8px rgba(0,0,0,0.1);
    }
    .stat-value {
      font-size: 32px;
      font-weight: 700;
      color: #667eea;
      margin: 10px 0;
    }
    .stat-label {
      font-size: 13px;
      color: #666;
      text-transform: uppercase;
      letter-spacing: 1px;
    }
    .log {
      background: #1e1e1e;
      color: #00ff00;
      padding: 15px;
      border-radius: 8px;
      font-family: 'Courier New', monospace;
      font-size: 12px;
      max-height: 300px;
      overflow-y: auto;
      margin-top: 15px;
    }
    .log-entry {
      margin: 3px 0;
    }
    .log-entry.error {
      color: #ff6b6b;
    }
    .log-entry.success {
      color: #51cf66;
    }
    .log-entry.info {
      color: #74c0fc;
    }
  </style>
</head>
<body>
  <div class="container">
    <h1>ğŸ§  ì¥ê¸° ê¸°ì–µ ì‹œìŠ¤í…œ í…ŒìŠ¤íŠ¸</h1>
    <p class="subtitle">ì‚¬ìš©ì 20ëª… Ã— 200ì¼ ëŒ€í™” ì‹œë®¬ë ˆì´ì…˜</p>

    <!-- í†µê³„ -->
    <div class="stats">
      <div class="stat-card">
        <div class="stat-label">í…ŒìŠ¤íŠ¸ ì‚¬ìš©ì</div>
        <div class="stat-value" id="userCount">20</div>
      </div>
      <div class="stat-card">
        <div class="stat-label">ì‹œë®¬ë ˆì´ì…˜ ê¸°ê°„</div>
        <div class="stat-value" id="dayCount">200</div>
      </div>
      <div class="stat-card">
        <div class="stat-label">ìƒì„±ëœ ëŒ€í™”</div>
        <div class="stat-value" id="convCount">0</div>
      </div>
      <div class="stat-card">
        <div class="stat-label">ì €ì¥ëœ ìš”ì•½</div>
        <div class="stat-value" id="summaryCount">0</div>
      </div>
    </div>

    <!-- Step 1: ë°ì´í„° ìƒì„± -->
    <div class="section">
      <h2>Step 1: í…ŒìŠ¤íŠ¸ ë°ì´í„° ìƒì„± <span class="status ready" id="status1">ëŒ€ê¸°</span></h2>
      <p>20ëª…ì˜ ê°€ìƒ ì‚¬ìš©ìê°€ 200ì¼ê°„ ë‚˜ëˆˆ ëŒ€í™” ë°ì´í„°ë¥¼ ìƒì„±í•©ë‹ˆë‹¤.</p>
      <button onclick="generateTestData()" id="btn1">ë°ì´í„° ìƒì„± ì‹œì‘</button>
      <div id="result1"></div>
    </div>

    <!-- Step 2: DB ì €ì¥ -->
    <div class="section">
      <h2>Step 2: DBì— ì €ì¥ <span class="status ready" id="status2">ëŒ€ê¸°</span></h2>
      <p>ìƒì„±ëœ ëŒ€í™”ì™€ ìš”ì•½ì„ Supabaseì— ì €ì¥í•©ë‹ˆë‹¤.</p>
      <button onclick="saveToDatabase()" id="btn2" disabled>DBì— ì €ì¥</button>
      <div id="result2"></div>
    </div>

    <!-- Step 3: ê¸°ì–µ í…ŒìŠ¤íŠ¸ -->
    <div class="section">
      <h2>Step 3: ì¥ê¸° ê¸°ì–µ í…ŒìŠ¤íŠ¸ <span class="status ready" id="status3">ëŒ€ê¸°</span></h2>
      <p>Edge Functionì´ ê³¼ê±° ëŒ€í™”ë¥¼ ê¸°ì–µí•˜ëŠ”ì§€ í…ŒìŠ¤íŠ¸í•©ë‹ˆë‹¤.</p>
      <button onclick="testMemory()" id="btn3" disabled>ê¸°ì–µ í…ŒìŠ¤íŠ¸ ì‹¤í–‰</button>
      <div id="result3"></div>
    </div>

    <!-- ë¡œê·¸ -->
    <div class="log" id="log"></div>
  </div>

  <script>
    const SUPABASE_URL = 'https://ooafoofzmowsbtbhticw.supabase.co';
    const SUPABASE_ANON_KEY = 'eyJhbGciOiJIUzI1NiIsInR5cCI6IkpXVCJ9.eyJpc3MiOiJzdXBhYmFzZSIsInJlZiI6Im9vYWZvb2Z6bW93c2J0Ymh0aWN3Iiwicm9sZSI6ImFub24iLCJpYXQiOjE3MjUyNjcxODUsImV4cCI6MjA0MDg0MzE4NX0.rhkHBLdqJmrYvWn0E8QZbCqBNSBdKGVW-_Ht-1vvA68';

    let testData = [];
    let savedConversations = [];

    // ì‹œë‚˜ë¦¬ì˜¤ í…œí”Œë¦¿ (200ì¼ê°„ì˜ ë‹¤ì–‘í•œ ëŒ€í™”)
    const scenarios = [
      { day: 1, user: "ì˜¤ëŠ˜ ìƒˆë¡œìš´ íšŒì‚¬ì— ì²« ì¶œê·¼í–ˆì–´", compact: "ì²« ì¶œê·¼, ê¸´ì¥ë¨" },
      { day: 3, user: "ì²« í”„ë¡œì íŠ¸ ë°°ì •ë°›ì•˜ëŠ”ë° ë–¨ë ¤", compact: "ìƒˆ í”„ë¡œì íŠ¸ ì‹œì‘, ë¶€ë‹´ë¨" },
      { day: 7, user: "ë™ë£Œë“¤ì´ ìƒê°ë³´ë‹¤ ì¹œì ˆí•´ì„œ ë‹¤í–‰ì´ì•¼", compact: "ë™ë£Œë“¤ ì¹œì ˆ, ì ì‘ ì¤‘" },
      { day: 14, user: "í”„ë¡œì íŠ¸ ì¤‘ê°„ ë°œí‘œ ì˜ ëë‚¬ì–´!", compact: "ë°œí‘œ ì„±ê³µ, ë¿Œë“¯í•¨" },
      { day: 30, user: "í•œ ë‹¬ ì°¨ ë“œë””ì–´ ì ì‘ëœ ê²ƒ ê°™ì•„", compact: "ì ì‘ ì™„ë£Œ, ìì‹ ê°" },
      { day: 45, user: "íŒ€ì¥ë‹˜ì´ ìŠ¹ì§„ ì œì•ˆí–ˆì–´", compact: "ìŠ¹ì§„ ì œì•ˆë°›ìŒ" },
      { day: 60, user: "ìŠ¹ì§„ ê²°ì •í–ˆì–´! ë‹¤ìŒ ë‹¬ë¶€í„° íŒ€ë¦¬ë”", compact: "ìŠ¹ì§„ í™•ì •, ê¸°ëŒ€ë¨" },
      { day: 90, user: "íŒ€ë¦¬ë” 3ê°œì›” ì°¨, ìƒê°ë³´ë‹¤ í˜ë“¤ë‹¤", compact: "ë¦¬ë” ì—­í•  ë¶€ë‹´" },
      { day: 120, user: "íŒ€ì›ì´ë‘ ê°ˆë“± ìƒê²¨ì„œ ìŠ¤íŠ¸ë ˆìŠ¤ì•¼", compact: "íŒ€ ê°ˆë“±, ìŠ¤íŠ¸ë ˆìŠ¤" },
      { day: 150, user: "ê°ˆë“± í•´ê²°í–ˆì–´! ì†”ì§í•˜ê²Œ ëŒ€í™”í–ˆë”ë‹ˆ", compact: "ê°ˆë“± í•´ê²°, í›„ë ¨í•¨" },
      { day: 180, user: "ì—°ë§ í‰ê°€ Aë“±ê¸‰ ë°›ì•˜ì–´", compact: "í‰ê°€ ìš°ìˆ˜, ë³´ëŒ" },
      { day: 200, user: "1ë…„ íšŒê³ í•˜ë‹ˆ ì •ë§ ë§ì´ ì„±ì¥í–ˆì–´", compact: "1ë…„ ì„±ì¥, ê°íšŒ" }
    ];

    function log(message, type = 'info') {
      const logDiv = document.getElementById('log');
      const entry = document.createElement('div');
      entry.className = `log-entry ${type}`;
      const timestamp = new Date().toLocaleTimeString();
      entry.textContent = `[${timestamp}] ${message}`;
      logDiv.appendChild(entry);
      logDiv.scrollTop = logDiv.scrollHeight;
    }

    // Step 1: í…ŒìŠ¤íŠ¸ ë°ì´í„° ìƒì„±
    async function generateTestData() {
      document.getElementById('status1').textContent = 'ì§„í–‰ì¤‘';
      document.getElementById('status1').className = 'status running';
      document.getElementById('btn1').disabled = true;

      log('í…ŒìŠ¤íŠ¸ ë°ì´í„° ìƒì„± ì‹œì‘...', 'info');
      testData = [];

      // 20ëª…ì˜ ì‚¬ìš©ì ìƒì„±
      for (let userId = 1; userId <= 20; userId++) {
        const userEmail = `test_user_${userId}@test.com`;

        // ê° ì‚¬ìš©ìë§ˆë‹¤ ì‹œë‚˜ë¦¬ì˜¤ ì¤‘ ì¼ë¶€ ì„ íƒ
        const userScenarios = scenarios.filter((_, i) => (userId + i) % 3 === 0);

        for (const scenario of userScenarios) {
          const conversation = {
            user_id: `test-user-${userId}`,
            user_email: userEmail,
            day: scenario.day,
            user_message: scenario.user,
            compact_summary: scenario.compact,
            detailed_summary: `ë‚˜ëŠ” ${scenario.user}. ${scenario.compact}ë¥¼ ëŠê¼ˆë‹¤.`
          };

          testData.push(conversation);
        }
      }

      log(`âœ“ ${testData.length}ê°œì˜ ëŒ€í™” ì‹œë‚˜ë¦¬ì˜¤ ìƒì„± ì™„ë£Œ`, 'success');
      document.getElementById('convCount').textContent = testData.length;

      const resultDiv = document.getElementById('result1');
      resultDiv.innerHTML = `
        <div class="result success">
          <strong>âœ“ ìƒì„± ì™„ë£Œ!</strong><br>
          â€¢ ì‚¬ìš©ì: 20ëª…<br>
          â€¢ ëŒ€í™”: ${testData.length}ê°œ<br>
          â€¢ ì‹œë®¬ë ˆì´ì…˜ ê¸°ê°„: 200ì¼
        </div>
      `;

      document.getElementById('status1').textContent = 'ì™„ë£Œ';
      document.getElementById('status1').className = 'status success';
      document.getElementById('btn2').disabled = false;
    }

    // Step 2: DB ì €ì¥
    async function saveToDatabase() {
      document.getElementById('status2').textContent = 'ì§„í–‰ì¤‘';
      document.getElementById('status2').className = 'status running';
      document.getElementById('btn2').disabled = true;

      log('Supabaseì— ë°ì´í„° ì €ì¥ ì‹œì‘...', 'info');

      try {
        // ì‚¬ìš©ìë³„ë¡œ ê·¸ë£¹í™”
        const userGroups = {};
        testData.forEach(conv => {
          if (!userGroups[conv.user_id]) {
            userGroups[conv.user_id] = [];
          }
          userGroups[conv.user_id].push(conv);
        });

        let totalSaved = 0;

        // ê° ì‚¬ìš©ìì˜ ë°ì´í„°ë¥¼ profile_dataì— ì €ì¥
        for (const [userId, conversations] of Object.entries(userGroups)) {
          const profileData = {
            conversation_summaries: {}
          };

          conversations.forEach((conv, index) => {
            const convId = `conv-${userId}-${conv.day}`;
            profileData.conversation_summaries[convId] = {
              compact_summary: conv.compact_summary,
              detailed_summary: conv.detailed_summary,
              summary: conv.detailed_summary,
              created_at: new Date(Date.now() - (200 - conv.day) * 24 * 60 * 60 * 1000).toISOString()
            };
          });

          // Supabaseì— ì €ì¥ (ì‹¤ì œ API í˜¸ì¶œ)
          const response = await fetch(`${SUPABASE_URL}/rest/v1/user_profiles`, {
            method: 'POST',
            headers: {
              'apikey': SUPABASE_ANON_KEY,
              'Authorization': `Bearer ${SUPABASE_ANON_KEY}`,
              'Content-Type': 'application/json',
              'Prefer': 'resolution=merge-duplicates'
            },
            body: JSON.stringify({
              user_id: userId,
              profile_data: profileData,
              last_updated_at: new Date().toISOString()
            })
          });

          if (response.ok) {
            totalSaved += conversations.length;
            log(`âœ“ ${userId}: ${conversations.length}ê°œ ëŒ€í™” ì €ì¥ ì™„ë£Œ`, 'success');
          } else {
            const error = await response.text();
            log(`âœ— ${userId} ì €ì¥ ì‹¤íŒ¨: ${error}`, 'error');
          }
        }

        document.getElementById('summaryCount').textContent = totalSaved;

        const resultDiv = document.getElementById('result2');
        resultDiv.innerHTML = `
          <div class="result success">
            <strong>âœ“ DB ì €ì¥ ì™„ë£Œ!</strong><br>
            â€¢ ì €ì¥ëœ ìš”ì•½: ${totalSaved}ê°œ<br>
            â€¢ ì‚¬ìš©ì: ${Object.keys(userGroups).length}ëª…
          </div>
        `;

        document.getElementById('status2').textContent = 'ì™„ë£Œ';
        document.getElementById('status2').className = 'status success';
        document.getElementById('btn3').disabled = false;

      } catch (error) {
        log(`âœ— ì €ì¥ ì˜¤ë¥˜: ${error.message}`, 'error');

        const resultDiv = document.getElementById('result2');
        resultDiv.innerHTML = `
          <div class="result fail">
            <strong>âœ— ì €ì¥ ì‹¤íŒ¨</strong><br>
            ${error.message}
          </div>
        `;

        document.getElementById('status2').textContent = 'ì‹¤íŒ¨';
        document.getElementById('status2').className = 'status error';
      }
    }

    // Step 3: ê¸°ì–µ í…ŒìŠ¤íŠ¸
    async function testMemory() {
      document.getElementById('status3').textContent = 'ì§„í–‰ì¤‘';
      document.getElementById('status3').className = 'status running';
      document.getElementById('btn3').disabled = true;

      log('ì¥ê¸° ê¸°ì–µ í…ŒìŠ¤íŠ¸ ì‹œì‘...', 'info');

      const testCases = [
        {
          user_id: 'test-user-1',
          message: 'ì˜¤ëŠ˜ë„ íšŒì‚¬ ì˜ ë‹¤ë…€ì™”ì–´',
          expectedMemory: 'ì²« ì¶œê·¼'
        },
        {
          user_id: 'test-user-5',
          message: 'í”„ë¡œì íŠ¸ ì§„í–‰ ìƒí™© ë¬¼ì–´ë´ì¤„ë˜?',
          expectedMemory: 'í”„ë¡œì íŠ¸'
        },
        {
          user_id: 'test-user-10',
          message: 'ìš”ì¦˜ ì–´ë•Œ?',
          expectedMemory: 'ìŠ¹ì§„'
        }
      ];

      let passCount = 0;
      let failCount = 0;
      const results = [];

      for (const testCase of testCases) {
        try {
          // Edge Function í˜¸ì¶œ
          const response = await fetch(`${SUPABASE_URL}/functions/v1/chat`, {
            method: 'POST',
            headers: {
              'Content-Type': 'application/json',
              'Authorization': `Bearer ${SUPABASE_ANON_KEY}`
            },
            body: JSON.stringify({
              user_id: testCase.user_id,
              content: testCase.message,
              messages: { items: [] },
              conversation_id: 'test-conv'
            })
          });

          const data = await response.json();
          const aiReply = data.reply || '';

          // ê³¼ê±° ê¸°ì–µì„ ì–¸ê¸‰í–ˆëŠ”ì§€ í™•ì¸
          const mentionsMemory = aiReply.includes('ì €ë²ˆ') ||
                                 aiReply.includes('ì „ì—') ||
                                 aiReply.includes('ë§í–ˆ') ||
                                 aiReply.toLowerCase().includes(testCase.expectedMemory.toLowerCase());

          if (mentionsMemory) {
            passCount++;
            log(`âœ“ ${testCase.user_id}: ê³¼ê±° ê¸°ì–µ í™œìš© ì„±ê³µ!`, 'success');
            results.push({
              user: testCase.user_id,
              status: 'success',
              message: testCase.message,
              reply: aiReply
            });
          } else {
            failCount++;
            log(`âœ— ${testCase.user_id}: ê³¼ê±° ê¸°ì–µ ë¯¸í™œìš©`, 'error');
            results.push({
              user: testCase.user_id,
              status: 'fail',
              message: testCase.message,
              reply: aiReply
            });
          }

        } catch (error) {
          failCount++;
          log(`âœ— ${testCase.user_id} í…ŒìŠ¤íŠ¸ ì˜¤ë¥˜: ${error.message}`, 'error');
        }
      }

      // ê²°ê³¼ í‘œì‹œ
      let resultHTML = `
        <div class="result ${passCount > failCount ? 'success' : 'fail'}">
          <strong>${passCount > failCount ? 'âœ“ í…ŒìŠ¤íŠ¸ í†µê³¼' : 'âœ— í…ŒìŠ¤íŠ¸ ì‹¤íŒ¨'}</strong><br>
          â€¢ ì„±ê³µ: ${passCount}/${testCases.length}<br>
          â€¢ ì‹¤íŒ¨: ${failCount}/${testCases.length}
        </div>
      `;

      results.forEach(r => {
        resultHTML += `
          <div class="test-scenario">
            <h3>${r.user} ${r.status === 'success' ? 'âœ“' : 'âœ—'}</h3>
            <div><strong>ì§ˆë¬¸:</strong> ${r.message}</div>
            <div class="conversation-history"><strong>AI ë‹µë³€:</strong> ${r.reply}</div>
          </div>
        `;
      });

      document.getElementById('result3').innerHTML = resultHTML;

      document.getElementById('status3').textContent = passCount > failCount ? 'ì„±ê³µ' : 'ì‹¤íŒ¨';
      document.getElementById('status3').className = passCount > failCount ? 'status success' : 'status error';

      log(`í…ŒìŠ¤íŠ¸ ì™„ë£Œ: ${passCount}/${testCases.length} ì„±ê³µ`, passCount > failCount ? 'success' : 'error');
    }
  </script>
</body>
</html>
